#!/usr/bin/env node

/**
 * Decision Detection Script
 *
 * Analyzes PostToolUse events to detect architectural decisions.
 * Reads tool result from stdin, evaluates against decision criteria,
 * and outputs a notification if a decision is detected.
 *
 * Generated by Plugin Factory v1.0
 */

const fs = require('fs');
const path = require('path');

// Decision detection patterns
const HIGH_SIGNAL_PATTERNS = [
  // Package management
  /package\.json$/,
  /package-lock\.json$/,
  /yarn\.lock$/,
  /pnpm-lock\.yaml$/,

  // Config files
  /tsconfig\.json$/,
  /jsconfig\.json$/,
  /vite\.config\.(js|ts)$/,
  /webpack\.config\.(js|ts)$/,
  /next\.config\.(js|ts|mjs)$/,
  /tailwind\.config\.(js|ts)$/,
  /\.eslintrc(\.(js|json|yaml))?$/,
  /\.prettierrc(\.(js|json|yaml))?$/,
  /jest\.config\.(js|ts)$/,
  /vitest\.config\.(js|ts)$/,

  // Schema and types
  /schema\.(ts|js|prisma|graphql)$/,
  /types\.(ts|d\.ts)$/,
  /models\//,

  // Docker and deployment
  /Dockerfile$/,
  /docker-compose\.ya?ml$/,
  /\.github\/workflows\//,
  /vercel\.json$/,
  /netlify\.toml$/,
];

const MEDIUM_SIGNAL_PATTERNS = [
  // Architectural directories
  /src\/(lib|utils|services|hooks|providers|contexts|stores)\//,

  // Naming patterns
  /[Pp]rovider\.(tsx?|jsx?)$/,
  /[Cc]ontext\.(tsx?|jsx?)$/,
  /[Ss]tore\.(tsx?|jsx?)$/,
  /[Mm]iddleware\.(tsx?|jsx?)$/,

  // Test files (testing strategy)
  /\.(test|spec)\.(tsx?|jsx?)$/,
  /__tests__\//,
];

// Keywords that indicate architectural significance (used to boost signal level)
const ARCHITECTURAL_KEYWORDS = [
  'migration', 'refactor', 'upgrade', 'replace', 'switch',
  'authentication', 'authorization', 'security',
  'database', 'schema', 'model',
  'api', 'endpoint', 'route',
  'state', 'store', 'context',
  'deploy', 'build', 'ci', 'cd',
];

/**
 * Check if file path contains architectural keywords
 */
function hasArchitecturalKeyword(filePath) {
  const lowerPath = filePath.toLowerCase();
  return ARCHITECTURAL_KEYWORDS.some(keyword => lowerPath.includes(keyword));
}

/**
 * Check if a file path matches decision criteria
 */
function getSignalLevel(filePath) {
  if (!filePath) return null;

  const normalizedPath = filePath.replace(/\\/g, '/');

  // Check high signal patterns
  for (const pattern of HIGH_SIGNAL_PATTERNS) {
    if (pattern.test(normalizedPath)) {
      return 'high';
    }
  }

  // Check medium signal patterns
  for (const pattern of MEDIUM_SIGNAL_PATTERNS) {
    if (pattern.test(normalizedPath)) {
      return 'medium';
    }
  }

  // Check architectural keywords in path (e.g., auth/, migration/, schema/)
  if (hasArchitecturalKeyword(normalizedPath)) {
    return 'medium';
  }

  return null;
}

/**
 * Extract file path from tool result
 */
function extractFilePath(toolResult) {
  // Handle different tool result formats
  if (typeof toolResult === 'string') {
    // Look for file path patterns
    const pathMatch = toolResult.match(/(?:File|Created|Updated|Wrote).*?[`"']?([\/\w\-\.]+\.\w+)[`"']?/i);
    if (pathMatch) return pathMatch[1];

    // Look for absolute paths
    const absMatch = toolResult.match(/(\/[\w\-\.\/]+\.\w+)/);
    if (absMatch) return absMatch[1];
  }

  if (typeof toolResult === 'object' && toolResult !== null) {
    return toolResult.file_path || toolResult.filePath || toolResult.path;
  }

  return null;
}

/**
 * Main detection logic
 */
async function main() {
  // Read tool result from stdin
  let input = '';

  try {
    input = fs.readFileSync(0, 'utf-8');
  } catch (e) {
    // No stdin available
    process.exit(0);
  }

  if (!input.trim()) {
    process.exit(0);
  }

  // Parse the tool result
  let toolResult;
  try {
    toolResult = JSON.parse(input);
  } catch (e) {
    toolResult = input;
  }

  // Extract file path
  const filePath = extractFilePath(toolResult);
  if (!filePath) {
    process.exit(0);
  }

  // Check signal level
  const signalLevel = getSignalLevel(filePath);

  if (signalLevel === 'high') {
    // High signal - always suggest recording decision
    const fileName = path.basename(filePath);
    console.log(JSON.stringify({
      type: 'decision_detected',
      level: 'high',
      file: filePath,
      message: `Architectural decision detected: ${fileName} was modified. Consider using /decision to record why.`
    }));
  } else if (signalLevel === 'medium') {
    // Medium signal - softer suggestion
    const fileName = path.basename(filePath);
    console.log(JSON.stringify({
      type: 'decision_detected',
      level: 'medium',
      file: filePath,
      message: `${fileName} looks architectural. Use /decision if this represents a design choice.`
    }));
  }

  // Exit cleanly
  process.exit(0);
}

main().catch(err => {
  console.error('Decision detection error:', err.message);
  process.exit(1);
});
