#!/usr/bin/env node

/**
 * Decision Capture Script
 *
 * Helper script to capture a decision and send it to the MCP server.
 * Called by the decision command or manually.
 *
 * Usage: node capture-decision.js --project /path --files file1,file2 --reasoning "text"
 *
 * Generated by Plugin Factory v1.0
 */

const { execSync } = require('child_process');
const path = require('path');

/**
 * Get current git commit hash
 */
function getGitCommit() {
  try {
    const commit = execSync('git rev-parse HEAD', {
      encoding: 'utf-8',
      stdio: ['pipe', 'pipe', 'pipe']
    }).trim();
    return commit.substring(0, 7); // Short hash
  } catch (e) {
    return null;
  }
}

/**
 * Get current git remote URL for linking
 */
function getGitRemote() {
  try {
    const remote = execSync('git remote get-url origin', {
      encoding: 'utf-8',
      stdio: ['pipe', 'pipe', 'pipe']
    }).trim();

    // Convert SSH to HTTPS
    if (remote.startsWith('git@')) {
      return remote
        .replace('git@', 'https://')
        .replace(':', '/')
        .replace(/\.git$/, '');
    }

    return remote.replace(/\.git$/, '');
  } catch (e) {
    return null;
  }
}

/**
 * Extract tags from reasoning text
 */
function extractTags(reasoning) {
  const keywords = [
    'react', 'vue', 'angular', 'svelte',
    'redux', 'zustand', 'jotai', 'recoil', 'context',
    'typescript', 'javascript', 'python', 'rust', 'go',
    'api', 'rest', 'graphql', 'trpc',
    'database', 'postgres', 'mysql', 'mongodb', 'sqlite', 'prisma',
    'auth', 'authentication', 'authorization', 'oauth', 'jwt',
    'testing', 'jest', 'vitest', 'cypress', 'playwright',
    'styling', 'css', 'tailwind', 'styled-components', 'sass',
    'build', 'webpack', 'vite', 'esbuild', 'rollup',
    'deploy', 'docker', 'kubernetes', 'vercel', 'netlify',
    'performance', 'optimization', 'caching', 'lazy-loading',
    'security', 'encryption', 'validation',
    'architecture', 'refactor', 'migration',
    'state-management', 'routing', 'middleware',
  ];

  const lowerReasoning = reasoning.toLowerCase();
  const foundTags = [];

  for (const keyword of keywords) {
    if (lowerReasoning.includes(keyword.replace('-', ' ')) ||
        lowerReasoning.includes(keyword)) {
      foundTags.push(keyword);
    }
  }

  // Limit to most relevant tags
  return [...new Set(foundTags)].slice(0, 5);
}

/**
 * Parse command line arguments
 */
function parseArgs(args) {
  const result = {
    project: process.cwd(),
    files: [],
    reasoning: '',
    commit: null,
    tags: []
  };

  for (let i = 0; i < args.length; i++) {
    switch (args[i]) {
      case '--project':
        result.project = args[++i];
        break;
      case '--files':
        result.files = args[++i].split(',').map(f => f.trim());
        break;
      case '--reasoning':
        result.reasoning = args[++i];
        break;
      case '--commit':
        result.commit = args[++i];
        break;
      case '--tags':
        result.tags = args[++i].split(',').map(t => t.trim());
        break;
    }
  }

  return result;
}

/**
 * Main capture logic
 */
async function main() {
  const args = parseArgs(process.argv.slice(2));

  if (!args.reasoning) {
    console.error('Error: --reasoning is required');
    process.exit(1);
  }

  // Get git info if not provided
  if (!args.commit) {
    args.commit = getGitCommit();
  }

  // Extract tags if not provided
  if (args.tags.length === 0) {
    args.tags = extractTags(args.reasoning);
  }

  // Get remote URL for commit links
  const remote = getGitRemote();

  // Build the decision object
  const decision = {
    project: args.project,
    files: args.files,
    reasoning: args.reasoning,
    commit: args.commit,
    tags: args.tags,
    commitUrl: remote && args.commit ? `${remote}/commit/${args.commit}` : null,
    timestamp: new Date().toISOString()
  };

  // Output as JSON for MCP server consumption
  console.log(JSON.stringify(decision, null, 2));
}

main().catch(err => {
  console.error('Capture error:', err.message);
  process.exit(1);
});
